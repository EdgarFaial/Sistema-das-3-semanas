<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Player Gamificado - Melhoria Pessoal</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÆ</text></svg>">
    <style>
        /* Estilos anteriores mantidos... */
        /* ... */
    </style>
</head>
<body>

    <!-- Gradiente SVG para o anel de progresso -->
    <svg style="position: absolute; width: 0; height: 0;">
        <defs>
            <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:var(--shogun-red);stop-opacity:1" />
                <stop offset="50%" style="stop-color:var(--neon-blue);stop-opacity:1" />
                <stop offset="100%" style="stop-color:var(--kimono-gold);stop-opacity:1" />
            </linearGradient>
        </defs>
    </svg>

    <div class="app-container">
        <!-- Cabe√ßalho -->
        <header class="app-header cyber-header">
            <h1><i class="fas fa-gamepad"></i> Player Gamificado</h1>
            <p>Transforme h√°bitos em conquistas di√°rias</p>
            <div class="tab-indicator">
                <span class="active" data-tab="home" onclick="switchScreen('home')"></span>
                <span data-tab="setup" onclick="switchScreen('setup')"></span>
                <span data-tab="log" onclick="switchScreen('log')"></span>
            </div>
        </header>

        <!-- Tela 1: Home (Dashboard) -->
        <div id="home-screen" class="screen active">
            <!-- Status do jogador -->
            <div class="player-status">
                <div class="player-info">
                    <div class="player-name" id="player-display-name">Jogador</div>
                    <div class="player-level">N√≠vel <span id="current-level">1</span></div>
                </div>
                <div class="xp-progress">
                    <div class="xp-bar">
                        <div class="xp-fill" id="level-progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="xp-info">
                        <span><span id="current-xp">0</span> XP</span>
                        <span><span id="next-level-xp">100</span> XP para pr√≥ximo n√≠vel</span>
                    </div>
                </div>
            </div>

            <!-- Seletor de data -->
            <div class="date-selector">
                <button class="date-nav-btn" id="prev-date">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="date-display">
                    <div class="current-date" id="current-date-display">Hoje</div>
                    <div class="date-info" id="date-info">Selecione uma data</div>
                </div>
                <button class="date-nav-btn" id="next-date">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Streaks -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-fire"></i> Streaks</h2>
                </div>
                <div class="streaks-container">
                    <div class="streak-card">
                        <div class="streak-value" id="global-streak">0</div>
                        <div class="streak-label">Global</div>
                    </div>
                    <div class="streak-card">
                        <div class="streak-value" id="total-points">0</div>
                        <div class="streak-label">Pontos Hoje</div>
                    </div>
                </div>
            </div>

            <!-- H√°bitos do dia -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-tasks"></i> H√°bitos de Hoje</h2>
                    <div class="progress-ring">
                        <svg class="progress-ring-circle" width="60" height="60">
                            <circle class="progress-ring-bg" cx="30" cy="30" r="24"></circle>
                            <circle class="progress-ring-fill" cx="30" cy="30" r="24" stroke-dasharray="150.8" stroke-dashoffset="150.8"></circle>
                        </svg>
                        <div class="progress-ring-text" id="habits-progress">0%</div>
                    </div>
                </div>
                <div id="daily-habits-container">
                    <!-- H√°bitos ser√£o carregados aqui -->
                    <div class="empty-state">
                        <i class="fas fa-plus-circle"></i>
                        <h3>Nenhum h√°bito configurado</h3>
                        <p>V√° para "Configura√ß√£o" para criar seus primeiros h√°bitos</p>
                        <button class="btn btn-primary" id="go-to-setup">Criar H√°bitos</button>
                    </div>
                </div>
                <button class="btn btn-success mt-2" id="save-daily">
                    <i class="fas fa-save"></i> Salvar Progresso
                </button>
            </div>

            <!-- Modo guiado -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-compass"></i> Comece Aqui</h2>
                </div>
                <p style="margin-bottom: 16px;">Novo no sistema? Comece com sugest√µes personalizadas:</p>
                <button class="btn btn-outline" id="start-guided-mode">
                    <i class="fas fa-magic"></i> Modo Guiado
                </button>
            </div>
        </div>

        <!-- Tela 2: Configura√ß√£o -->
        <div id="setup-screen" class="screen">
            <!-- Se√ß√£o de perfil -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-user"></i> Seu Perfil</h2>
                </div>
                <div class="form-group">
                    <label class="form-label" for="player-name">Nome do Jogador</label>
                    <input type="text" class="form-input" id="player-name" placeholder="Digite seu nome">
                </div>
                <button class="btn btn-primary" id="save-player-name">
                    <i class="fas fa-check"></i> Salvar Nome
                </button>
                <div class="mt-2">
                    <small>Nota: Seu nome ser√° usado como ID √∫nico no sistema</small>
                </div>
            </div>

            <!-- Atributos -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-layer-group"></i> Atributos</h2>
                    <span class="badge" id="mandatory-count">0/3 obrigat√≥rios</span>
                </div>
                <p style="margin-bottom: 16px; color: var(--gray); font-size: 0.9rem;">
                    M√≠nimo 3 atributos obrigat√≥rios, m√°ximo 5. Opcionais n√£o geram pontos.
                </p>
                
                <div class="form-group">
                    <label class="form-label" for="new-attribute-name">Novo Atributo</label>
                    <input type="text" class="form-input" id="new-attribute-name" placeholder="Ex: CORPO, MENTE">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="new-attribute-type">Tipo</label>
                    <select class="form-select" id="new-attribute-type">
                        <option value="mandatory">Obrigat√≥rio (gera pontos)</option>
                        <option value="optional">Opcional (sem pontos)</option>
                    </select>
                </div>
                
                <button class="btn btn-success" id="add-attribute">
                    <i class="fas fa-plus"></i> Adicionar Atributo
                </button>

                <div id="attributes-list" class="mt-3">
                    <!-- Lista de atributos ser√° carregada aqui -->
                    <div class="empty-state" id="no-attributes-message">
                        <i class="fas fa-layer-group"></i>
                        <h3>Nenhum atributo criado</h3>
                        <p>Crie seu primeiro atributo para come√ßar</p>
                    </div>
                </div>
            </div>

            <!-- H√°bitos -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-tasks"></i> H√°bitos</h2>
                </div>
                <p style="margin-bottom: 16px; color: var(--gray); font-size: 0.9rem;">
                    Crie h√°bitos associados aos atributos. Pontos s√£o calculados automaticamente.
                </p>
                
                <div class="form-group">
                    <label class="form-label" for="new-habit-name">Novo H√°bito</label>
                    <input type="text" class="form-input" id="new-habit-name" placeholder="Ex: Beber 2L de √°gua">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="new-habit-attribute">Atributo Associado</label>
                    <select class="form-select" id="new-habit-attribute">
                        <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="new-habit-type">Tipo</label>
                    <select class="form-select" id="new-habit-type">
                        <option value="binary">Bin√°rio (feito/n√£o feito) - 10 pontos</option>
                        <option value="quantitative">Quantitativo (valor num√©rico) - 1 ponto/unidade</option>
                    </select>
                </div>
                
                <div class="form-group" id="habit-target-container">
                    <label class="form-label" for="new-habit-target">Meta Di√°ria</label>
                    <input type="number" class="form-input" id="new-habit-target" min="1" value="1">
                    <small style="color: var(--gray); font-size: 0.85rem;">Para h√°bitos bin√°rios: 1 = feito</small>
                </div>
                
                <button class="btn btn-success" id="add-habit">
                    <i class="fas fa-plus"></i> Adicionar H√°bito
                </button>

                <div id="habits-list" class="mt-3">
                    <!-- Lista de h√°bitos ser√° carregada aqui -->
                    <div class="empty-state" id="no-habits-message">
                        <i class="fas fa-tasks"></i>
                        <h3>Nenhum h√°bito criado</h3>
                        <p>Crie seu primeiro h√°bito para come√ßar a registrar</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tela 3: Log -->
        <div id="log-screen" class="screen">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-file-code"></i> Gerar Log</h2>
                </div>
                <p style="margin-bottom: 16px;">
                    Gere um log JSON do seu progresso di√°rio.
                </p>
                
                <div class="form-group">
                    <label class="form-label" for="log-date">Data do Log</label>
                    <input type="date" class="form-input" id="log-date" max="">
                </div>
                
                <button class="btn btn-primary" id="generate-log">
                    <i class="fas fa-cogs"></i> Gerar Log
                </button>

                <div id="log-output-container" class="mt-3" style="display: none;">
                    <label class="form-label">Log Gerado (JSON)</label>
                    <div class="log-output" id="log-output"></div>
                    <button class="btn btn-success" id="copy-log">
                        <i class="fas fa-copy"></i> Copiar Log
                    </button>
                </div>
            </div>

            <!-- Hist√≥rico -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-history"></i> Hist√≥rico</h2>
                </div>
                <div id="history-list">
                    <!-- Hist√≥rico ser√° carregado aqui -->
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <h3>Nenhum registro hist√≥rico</h3>
                        <p>Registre seus h√°bitos di√°rios para ver o hist√≥rico aqui</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Menu de navega√ß√£o inferior -->
        <nav class="nav-tabs">
            <a href="#" class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span class="tab-label">In√≠cio</span>
            </a>
            <a href="#" class="nav-tab" data-screen="setup">
                <i class="fas fa-cog"></i>
                <span class="tab-label">Configura√ß√£o</span>
            </a>
            <a href="#" class="nav-tab" data-screen="log">
                <i class="fas fa-file-alt"></i>
                <span class="tab-label">Log</span>
            </a>
        </nav>
    </div>

    <!-- Modal de Modo Guiado -->
    <div id="guided-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-magic"></i> Modo Guiado
                </h3>
                <button class="modal-close" id="close-guided-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Selecione a √°rea que voc√™ gostaria de melhorar primeiro:</p>
                
                <div class="guided-options mt-3">
                    <button class="btn btn-outline guided-option" data-area="CORPO">
                        <i class="fas fa-heartbeat"></i> Corpo
                    </button>
                    <button class="btn btn-outline guided-option" data-area="MENTE">
                        <i class="fas fa-brain"></i> Mente
                    </button>
                    <button class="btn btn-outline guided-option" data-area="ORGANIZACAO">
                        <i class="fas fa-calendar-check"></i> Organiza√ß√£o
                    </button>
                    <button class="btn btn-outline guided-option" data-area="RELACIONAMENTOS">
                        <i class="fas fa-users"></i> Relacionamentos
                    </button>
                </div>
                
                <div id="guided-result" class="mt-3" style="display: none;">
                    <div class="card">
                        <div id="guided-suggestion"></div>
                        <p class="motivational-phrase mt-2" id="motivational-phrase"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de sele√ß√£o/ cria√ß√£o de jogador -->
    <div id="player-select-modal" class="modal-overlay" style="display: flex;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-gamepad"></i> Selecione ou Crie seu Jogador
                </h3>
            </div>
            <div class="modal-body">
                <div id="select-player-section">
                    <h4>Selecione um jogador existente:</h4>
                    <div id="players-list" class="mt-2" style="max-height: 200px; overflow-y: auto;">
                        <div class="empty-state">
                            <i class="fas fa-spinner loading"></i>
                            <p>Carregando jogadores...</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3" style="border-top: 1px solid var(--cyber-border); padding-top: 15px;">
                    <h4>Ou crie um novo jogador:</h4>
                    <div class="form-group mt-2">
                        <input type="text" class="form-input" id="new-player-name" placeholder="Digite seu nome">
                    </div>
                    <button class="btn btn-primary" id="create-new-player">
                        <i class="fas fa-plus"></i> Criar Novo Jogador
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Toast -->
    <div id="feedback-toast" class="feedback d-none">
        <div class="feedback-icon">
            <i class="fas fa-check"></i>
        </div>
        <div class="feedback-content" id="feedback-message">Mensagem de feedback</div>
    </div>

    <!-- JavaScript -->
    <script>
        // ============================================
        // CONFIGURA√á√ïES DA API
        // ============================================
        const API_BASE_URL = 'https://api-3-semanas.onrender.com';
        
        const CONFIG = {
            BINARY_HABIT_POINTS: 10,
            QUANTITATIVE_POINTS_PER_UNIT: 1,
            MAX_POINTS_PER_ATTRIBUTE: 50,
            MAX_POINTS_PER_DAY: 200,
            BASE_LEVEL_XP: 100,
            LEVEL_MULTIPLIER: 1.5,
            MAX_MANDATORY_ATTRIBUTES: 5,
            MIN_MANDATORY_ATTRIBUTES: 3,
            GUIDED_LOCK_DAYS: 5
        };

        const MOTIVATIONAL_PHRASES = [
            "Grandes jornadas come√ßam com pequenos passos!",
            "Consist√™ncia √© a chave para o sucesso!",
            "Voc√™ √© mais forte do que imagina!",
            "Cada dia √© uma nova oportunidade!",
            "Pequenos h√°bitos, grandes transforma√ß√µes!",
            "O progresso acontece fora da zona de conforto!",
            "Voc√™ est√° construindo algo incr√≠vel!",
            "Continue! Voc√™ est√° indo muito bem!"
        ];

        const GUIDED_SUGGESTIONS = {
            "CORPO": {
                attribute: "SA√öDE F√çSICA",
                habit: "Beber um copo de √°gua ao acordar",
                type: "binary",
                target: 1,
                icon: "fas fa-heartbeat"
            },
            "MENTE": {
                attribute: "SA√öDE MENTAL",
                habit: "Respirar profundamente por 1 minuto",
                type: "binary",
                target: 1,
                icon: "fas fa-brain"
            },
            "ORGANIZACAO": {
                attribute: "PRODUTIVIDADE",
                habit: "Anotar 1 tarefa importante do dia",
                type: "binary",
                target: 1,
                icon: "fas fa-calendar-check"
            },
            "RELACIONAMENTOS": {
                attribute: "CONEX√ïES",
                habit: "Enviar uma mensagem positiva para algu√©m",
                type: "binary",
                target: 1,
                icon: "fas fa-users"
            }
        };

        // ============================================
        // ESTADO DA APLICA√á√ÉO
        // ============================================
        let state = {
            playerId: null, // Agora ser√° o nome do jogador
            playerData: null,
            currentDate: new Date().toISOString().split('T')[0],
            isLoading: false
        };

        // ============================================
        // FUN√á√ïES DA API (Fetch API)
        // ============================================
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            try {
                const response = await fetch(url, {
                    ...options,
                    headers
                });
                
                if (!response.ok) {
                    let errorMessage = `Erro HTTP: ${response.status}`;
                    
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        // Ignora se n√£o conseguir parsear JSON
                    }
                    
                    throw new Error(errorMessage);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                showFeedback(`Erro de conex√£o: ${error.message}`, 'danger');
                throw error;
            }
        }

        async function loadAllPlayers() {
            try {
                // A API n√£o tem endpoint para listar todos os jogadores
                // Como alternativa, podemos tentar carregar um jogador espec√≠fico
                // ou mostrar apenas os jogadores salvos no localStorage anteriormente
                
                return await apiRequest("/players", {method:"GET"});
            } catch (error) {
                console.error('Erro ao carregar jogadores:', error);
                return [];
            }
        }

        async function loadPlayer(playerName) {
            try {
                const data = await apiRequest(`/players/${playerName}`);
                state.playerId = playerName;
                state.playerData = data;
                localStorage.setItem('lastPlayer', playerName);
                return data;
            } catch (error) {
                if (error.message.includes('404')) {
                    return null;
                }
                throw error;
            }
        }

        async function createPlayer(playerData) {
            try {
                // Valida estrutura m√≠nima
                if (!playerData.player) {
                    throw new Error('Nome do jogador √© obrigat√≥rio');
                }
                
                // Garante estrutura b√°sica
                const completePlayerData = {
                    player: playerData.player,
                    date: playerData.date || state.currentDate,
                    attributesConfig: playerData.attributesConfig || {
                        mandatory: [],
                        optional: []
                    },
                    habits: playerData.habits || [],
                    attributePoints: playerData.attributePoints || {},
                    streaks: playerData.streaks || { global: 0 },
                    totalPoints: playerData.totalPoints || 0,
                    level: playerData.level || 1
                };
                
                const data = await apiRequest('/players', {
                    method: 'POST',
                    body: JSON.stringify(completePlayerData)
                });
                
                state.playerId = completePlayerData.player;
                state.playerData = data;
                localStorage.setItem('lastPlayer', completePlayerData.player);
                return data;
            } catch (error) {
                console.error('Erro ao criar jogador:', error);
                throw error;
            }
        }

        async function updatePlayer(playerName, updateData) {
            try {
                // Pega os dados atuais primeiro
                const currentData = state.playerData || await loadPlayer(playerName);
                if (!currentData) {
                    throw new Error('Jogador n√£o encontrado');
                }
                
                // Mescla os dados atualizados com os atuais
                const mergedData = {
                    ...currentData,
                    ...updateData
                };
                
                // Remove _id se existir (n√£o deve ser enviado no update)
                delete mergedData._id;
                
                const data = await apiRequest(`/players/${playerName}`, {
                    method: 'PUT',
                    body: JSON.stringify(mergedData)
                });
                
                // Atualiza o estado local
                state.playerData = data;
                
                return data;
            } catch (error) {
                console.error('Erro ao atualizar jogador:', error);
                throw error;
            }
        }

        async function deletePlayer(playerName) {
            try {
                const response = await apiRequest(`/players/${playerName}`, {
                    method: 'DELETE'
                });
                
                // Limpa estado local se for o jogador atual
                if (state.playerId === playerName) {
                    state.playerId = null;
                    state.playerData = null;
                    localStorage.removeItem('lastPlayer');
                }
                
                return response;
            } catch (error) {
                console.error('Erro ao deletar jogador:', error);
                throw error;
            }
        }

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        async function initApp() {
            console.log('üöÄ Inicializando Player Gamificado com API...');
            
            // Configura data m√°xima (hoje)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('log-date').max = today;
            
            // Verifica se tem um jogador salvo
            const savedPlayer = localStorage.getItem('lastPlayer');
            
            if (savedPlayer) {
                try {
                    state.isLoading = true;
                    const playerData = await loadPlayer(savedPlayer);
                    
                    if (playerData) {
                        // Jogador encontrado, fecha modal e carrega dados
                        document.getElementById('player-select-modal').style.display = 'none';
                        setupEventListeners();
                        updateUI();
                        showFeedback(`Bem-vindo de volta, ${savedPlayer}!`, 'success');
                    } else {
                        // Jogador n√£o encontrado, mostra modal
                        showPlayerSelectModal();
                    }
                } catch (error) {
                    console.error('Erro ao carregar jogador salvo:', error);
                    showPlayerSelectModal();
                } finally {
                    state.isLoading = false;
                }
            } else {
                // Mostra modal para selecionar/criar jogador
                showPlayerSelectModal();
            }
        }

        function showPlayerSelectModal() {
            const modal = document.getElementById('player-select-modal');
            modal.style.display = 'flex';
            
            // Carrega lista de jogadores
            loadPlayersList();
            
            // Configura eventos do modal
            document.getElementById('create-new-player').addEventListener('click', async () => {
                const playerName = document.getElementById('new-player-name').value.trim();
                
                if (!playerName) {
                    showFeedback('Digite um nome para o jogador', 'warning');
                    return;
                }
                
                try {
                    state.isLoading = true;
                    
                    // Cria jogador com estrutura b√°sica
                    const playerData = {
                        player: playerName,
                        date: state.currentDate,
                        attributesConfig: {
                            mandatory: [],
                            optional: []
                        },
                        habits: [],
                        attributePoints: {},
                        streaks: { global: 0 },
                        totalPoints: 0,
                        level: 1
                    };
                    
                    await createPlayer(playerData);
                    
                    modal.style.display = 'none';
                    setupEventListeners();
                    updateUI();
                    
                    showFeedback(`Jogador ${playerName} criado com sucesso!`, 'success');
                } catch (error) {
                    if (error.message.includes('400')) {
                        showFeedback('Este nome j√° est√° em uso. Escolha outro.', 'warning');
                    } else {
                        showFeedback('Erro ao criar jogador', 'danger');
                    }
                } finally {
                    state.isLoading = false;
                }
            });
            
            // Permite Enter para criar jogador
            document.getElementById('new-player-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('create-new-player').click();
                }
            });
        }

        async function loadPlayersList() {
            const container = document.getElementById('players-list');
            
            try {
                const players = await loadAllPlayers();
                
                if (players.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>Nenhum jogador encontrado</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = players.map(player => `
                    <div class="list-item" onclick="selectPlayer('${player.player}')">
                        <div class="list-item-info">
                            <div class="list-item-title">${player.player}</div>
                            <div class="list-item-subtitle">
                                N√≠vel ${player.level || 1} ‚Ä¢ ${player.totalPoints || 0} pontos
                            </div>
                        </div>
                        <div class="list-item-actions">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erro ao carregar jogadores</p>
                    </div>
                `;
            }
        }

        async function selectPlayer(playerName) {
            try {
                state.isLoading = true;
                await loadPlayer(playerName);
                
                document.getElementById('player-select-modal').style.display = 'none';
                setupEventListeners();
                updateUI();
                
                showFeedback(`Bem-vindo, ${playerName}!`, 'success');
            } catch (error) {
                showFeedback('Erro ao carregar jogador', 'danger');
            } finally {
                state.isLoading = false;
            }
        }

        // ============================================
        // FUN√á√ïES DE UI
        // ============================================
        function updateUI() {
            if (!state.playerData) return;
            
            updatePlayerInfo();
            updateDateDisplay();
            updateHabitsList();
            updateAttributesList();
            updateStreaksDisplay();
            updateProgressRing();
            updateHistoryList();
        }

        function updatePlayerInfo() {
            if (!state.playerData) return;
            
            // Nome do jogador
            document.getElementById('player-display-name').textContent = state.playerData.player;
            document.getElementById('player-name').value = state.playerData.player;
            
            // N√≠vel e XP
            const levelData = calculateLevelData();
            document.getElementById('current-level').textContent = state.playerData.level || 1;
            document.getElementById('current-xp').textContent = state.playerData.totalPoints || 0;
            document.getElementById('next-level-xp').textContent = levelData.xpForNextLevel;
            
            // Barra de progresso
            const progressPercent = (levelData.xpInCurrentLevel / levelData.xpForNextLevel) * 100;
            document.getElementById('level-progress-bar').style.width = `${Math.min(progressPercent, 100)}%`;
        }

        function updateDateDisplay() {
            const date = new Date(state.currentDate);
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            let displayText = formatDate(date);
            let infoText = '';
            
            if (state.currentDate === today) {
                displayText = 'Hoje';
                infoText = formatDate(date);
            } else if (state.currentDate === yesterdayStr) {
                displayText = 'Ontem';
                infoText = formatDate(date);
            }
            
            document.getElementById('current-date-display').textContent = displayText;
            document.getElementById('date-info').textContent = infoText;
        }

        function updateHabitsList() {
            const container = document.getElementById('daily-habits-container');
            
            if (!state.playerData || !state.playerData.habits || state.playerData.habits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-plus-circle"></i>
                        <h3>Nenhum h√°bito configurado</h3>
                        <p>V√° para "Configura√ß√£o" para criar seus primeiros h√°bitos</p>
                        <button class="btn btn-primary" id="go-to-setup">Criar H√°bitos</button>
                    </div>
                `;
                
                if (document.getElementById('go-to-setup')) {
                    document.getElementById('go-to-setup').addEventListener('click', () => switchScreen('setup'));
                }
                return;
            }
            
            // Mostra os h√°bitos do jogador
            container.innerHTML = state.playerData.habits.map((habit, index) => {
                const isBinary = habit.type === 'binary';
                const completed = habit.completed || false;
                const currentValue = habit.currentValue || 0;
                const target = habit.value || 1;
                const progress = target > 0 ? Math.min((currentValue / target) * 100, 100) : 0;
                
                return `
                    <div class="habit-item" data-habit-index="${index}">
                        <div class="habit-checkbox ${completed ? 'completed' : ''}" 
                             onclick="toggleHabitCompletion(${index})">
                            ${completed ? '<i class="fas fa-check"></i>' : ''}
                        </div>
                        <div class="habit-info">
                            <div class="habit-name">${habit.name}</div>
                            <div class="habit-meta">
                                <span>${habit.attribute}</span>
                                <span>‚Ä¢</span>
                                <span>${isBinary ? 'Feito/N√£o' : `${currentValue}/${target}`}</span>
                            </div>
                            ${!isBinary ? `
                                <div class="progress-bar mt-1">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="habit-points">${isBinary ? '10p' : '1p/unid.'}</div>
                    </div>
                `;
            }).join('');
            
            // Calcula progresso total
            const totalHabits = state.playerData.habits.length;
            const completedHabits = state.playerData.habits.filter(h => h.completed).length;
            const progressPercent = totalHabits > 0 ? (completedHabits / totalHabits) * 100 : 0;
            
            updateProgressRing(progressPercent);
        }

        function updateAttributesList() {
            const container = document.getElementById('attributes-list');
            
            if (!state.playerData || !state.playerData.attributesConfig) {
                container.innerHTML = `
                    <div class="empty-state" id="no-attributes-message">
                        <i class="fas fa-layer-group"></i>
                        <h3>Nenhum atributo criado</h3>
                        <p>Crie seu primeiro atributo para come√ßar</p>
                    </div>
                `;
                return;
            }
            
            const mandatoryAttributes = state.playerData.attributesConfig.mandatory || [];
            const optionalAttributes = state.playerData.attributesConfig.optional || [];
            const allAttributes = [
                ...mandatoryAttributes.map(name => ({ name, type: 'mandatory' })), 
                ...optionalAttributes.map(name => ({ name, type: 'optional' }))
            ];
            
            // Atualiza contador de obrigat√≥rios
            const mandatoryCount = mandatoryAttributes.length;
            document.getElementById('mandatory-count').textContent = `${mandatoryCount}/${CONFIG.MIN_MANDATORY_ATTRIBUTES} obrigat√≥rios`;
            
            if (allAttributes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" id="no-attributes-message">
                        <i class="fas fa-layer-group"></i>
                        <h3>Nenhum atributo criado</h3>
                        <p>Crie seu primeiro atributo para come√ßar</p>
                    </div>
                `;
                return;
            }
            
            // Atualiza lista
            container.innerHTML = allAttributes.map(attribute => {
                const streak = state.playerData.streaks ? (state.playerData.streaks[attribute.name] || 0) : 0;
                const points = state.playerData.attributePoints ? (state.playerData.attributePoints[attribute.name] || 0) : 0;
                
                return `
                    <div class="list-item ${attribute.type === 'optional' ? 'optional' : ''}">
                        <div class="list-item-info">
                            <div class="list-item-title">
                                ${attribute.name}
                                ${attribute.type === 'mandatory' ? 
                                    '<span style="color: var(--danger); font-size: 0.8em;"> (obrigat√≥rio)</span>' : 
                                    '<span style="color: var(--gray); font-size: 0.8em;"> (opcional)</span>'}
                            </div>
                            <div class="list-item-subtitle">
                                Streak: ${streak} dias ${streak >= 7 ? 'üî•' : ''}
                                ${attribute.type === 'mandatory' ? `‚Ä¢ Pontos: ${points}` : ''}
                            </div>
                        </div>
                        <div class="list-item-actions">
                            <button class="btn-small btn-danger" onclick="removeAttribute('${attribute.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Atualiza dropdown de atributos para h√°bitos
            updateAttributeDropdown();
        }

        function updateAttributeDropdown() {
            const select = document.getElementById('new-habit-attribute');
            select.innerHTML = '';
            
            if (!state.playerData || !state.playerData.attributesConfig) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Crie atributos primeiro';
                select.appendChild(option);
                return;
            }
            
            const mandatoryAttributes = state.playerData.attributesConfig.mandatory || [];
            
            if (mandatoryAttributes.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Crie atributos obrigat√≥rios primeiro';
                select.appendChild(option);
                return;
            }
            
            mandatoryAttributes.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (obrigat√≥rio)`;
                select.appendChild(option);
            });
        }

        function updateStreaksDisplay() {
            if (!state.playerData) {
                document.getElementById('global-streak').textContent = '0';
                document.getElementById('total-points').textContent = '0';
                return;
            }
            
            // Global streak
            const globalStreak = state.playerData.streaks?.global || 0;
            document.getElementById('global-streak').textContent = globalStreak;
            
            // Pontos totais
            const totalPoints = state.playerData.totalPoints || 0;
            document.getElementById('total-points').textContent = totalPoints;
        }

        function updateProgressRing(percent = 0) {
            const circle = document.querySelector('.progress-ring-fill');
            const text = document.getElementById('habits-progress');
            
            const radius = 24;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percent / 100) * circumference;
            
            if (circle) {
                circle.style.strokeDasharray = `${circumference} ${circumference}`;
                circle.style.strokeDashoffset = offset;
            }
            if (text) {
                text.textContent = `${Math.round(percent)}%`;
            }
        }

        function updateHistoryList() {
            const container = document.getElementById('history-list');
            
            // Como a API n√£o tem hist√≥rico espec√≠fico, mostramos informa√ß√µes do jogador
            if (!state.playerData) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <h3>Nenhum registro hist√≥rico</h3>
                        <p>Registre seus h√°bitos di√°rios para ver o hist√≥rico aqui</p>
                    </div>
                `;
                return;
            }
            
            const lastUpdated = state.playerData.date || state.currentDate;
            const level = state.playerData.level || 1;
            const totalPoints = state.playerData.totalPoints || 0;
            const totalHabits = state.playerData.habits?.length || 0;
            const completedHabits = state.playerData.habits?.filter(h => h.completed).length || 0;
            
            container.innerHTML = `
                <div class="history-item">
                    <div class="history-date">${formatDate(lastUpdated, true)}</div>
                    <div class="history-content">
                        <div class="history-stats">
                            <span><i class="fas fa-trophy"></i> N√≠vel ${level}</span>
                            <span><i class="fas fa-star"></i> ${totalPoints} pontos</span>
                            <span><i class="fas fa-tasks"></i> ${completedHabits}/${totalHabits} h√°bitos</span>
                        </div>
                        <div class="history-actions">
                            <button class="btn-small btn-outline" onclick="generateLog()">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // FUN√á√ïES DE NEG√ìCIO
        // ============================================
        function calculateLevelData() {
            if (!state.playerData) {
                return { xpForNextLevel: CONFIG.BASE_LEVEL_XP, xpInCurrentLevel: 0 };
            }
            
            const totalPoints = state.playerData.totalPoints || 0;
            let level = 1;
            let xpForNextLevel = CONFIG.BASE_LEVEL_XP;
            let xpForCurrentLevel = 0;
            let totalXpNeeded = CONFIG.BASE_LEVEL_XP;
            
            while (totalPoints >= totalXpNeeded) {
                level++;
                xpForCurrentLevel = totalXpNeeded;
                xpForNextLevel = Math.floor(CONFIG.BASE_LEVEL_XP * Math.pow(CONFIG.LEVEL_MULTIPLIER, level - 1));
                totalXpNeeded += xpForNextLevel;
            }
            
            return {
                xpForNextLevel,
                xpInCurrentLevel: totalPoints - xpForCurrentLevel
            };
        }

        async function toggleHabitCompletion(habitIndex) {
            if (!state.playerData || !state.playerData.habits) return;
            
            if (habitIndex < 0 || habitIndex >= state.playerData.habits.length) return;
            
            try {
                state.isLoading = true;
                
                const habit = state.playerData.habits[habitIndex];
                const isBinary = habit.type === 'binary';
                let updatedHabits = [...state.playerData.habits];
                
                if (isBinary) {
                    // Alterna entre feito/n√£o feito
                    updatedHabits[habitIndex] = {
                        ...habit,
                        completed: !habit.completed,
                        currentValue: habit.completed ? 0 : 1
                    };
                } else {
                    // Incrementa valor quantitativo
                    const currentValue = habit.currentValue || 0;
                    const target = habit.value || 1;
                    const newValue = Math.min(currentValue + 1, target);
                    
                    updatedHabits[habitIndex] = {
                        ...habit,
                        currentValue: newValue,
                        completed: newValue >= target
                    };
                }
                
                // Calcula pontos
                const updatedHabit = updatedHabits[habitIndex];
                const pointsEarned = isBinary ? 
                    (updatedHabit.completed ? CONFIG.BINARY_HABIT_POINTS : -CONFIG.BINARY_HABIT_POINTS) :
                    (updatedHabit.currentValue > (habit.currentValue || 0) ? CONFIG.QUANTITATIVE_POINTS_PER_UNIT : 0);
                
                // Atualiza pontos do atributo
                const attribute = updatedHabit.attribute;
                const currentAttributePoints = state.playerData.attributePoints?.[attribute] || 0;
                const newAttributePoints = Math.max(0, currentAttributePoints + pointsEarned);
                
                // Atualiza pontos totais
                const currentTotalPoints = state.playerData.totalPoints || 0;
                const newTotalPoints = Math.max(0, currentTotalPoints + pointsEarned);
                
                // Atualiza streaks
                const updatedStreaks = { ...state.playerData.streaks };
                
                // Atualiza level
                const levelData = calculateLevelData();
                const newLevel = Math.floor(newTotalPoints / CONFIG.BASE_LEVEL_XP) + 1;
                
                await updatePlayer(state.playerData.player, {
                    habits: updatedHabits,
                    attributePoints: {
                        ...state.playerData.attributePoints,
                        [attribute]: newAttributePoints
                    },
                    totalPoints: newTotalPoints,
                    level: newLevel,
                    streaks: updatedStreaks
                });
                
                updateUI();
                
                const message = isBinary ? 
                    (updatedHabit.completed ? 'H√°bito completado!' : 'H√°bito desmarcado') :
                    `Progresso: ${updatedHabit.currentValue}/${updatedHabit.value}`;
                
                showFeedback(message, 'success');
            } catch (error) {
                showFeedback('Erro ao atualizar h√°bito', 'danger');
            } finally {
                state.isLoading = false;
            }
        }

        async function saveDailyProgress() {
            if (!state.playerData) {
                showFeedback('Selecione ou crie um jogador primeiro', 'warning');
                return;
            }
            
            try {
                state.isLoading = true;
                
                // Atualiza data atual
                const today = new Date().toISOString().split('T')[0];
                await updatePlayer(state.playerData.player, {
                    date: today
                });
                
                // Calcula streaks
                const lastDate = state.playerData.date;
                const updatedStreaks = { ...state.playerData.streaks };
                
                if (lastDate === today) {
                    // J√° atualizou hoje, mant√©m streaks
                } else {
                    // Novo dia, verifica se manteve streaks
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    
                    if (lastDate === yesterdayStr) {
                        // Manteve o streak, incrementa
                        updatedStreaks.global = (updatedStreaks.global || 0) + 1;
                        
                        // Incrementa streaks dos atributos com h√°bitos completados
                        const completedHabits = state.playerData.habits?.filter(h => h.completed) || [];
                        completedHabits.forEach(habit => {
                            const attribute = habit.attribute;
                            updatedStreaks[attribute] = (updatedStreaks[attribute] || 0) + 1;
                        });
                    } else {
                        // Quebrou o streak, reseta
                        updatedStreaks.global = 0;
                        // Mant√©m apenas os atributos que j√° tinham streak
                        Object.keys(updatedStreaks).forEach(key => {
                            if (key !== 'global') {
                                updatedStreaks[key] = 0;
                            }
                        });
                    }
                }
                
                await updatePlayer(state.playerData.player, {
                    streaks: updatedStreaks
                });
                
                showFeedback('Progresso salvo com sucesso!', 'success');
            } catch (error) {
                showFeedback('Erro ao salvar progresso', 'danger');
            } finally {
                state.isLoading = false;
            }
        }

        async function addAttribute() {
            if (!state.playerData) {
                showFeedback('Selecione ou crie um jogador primeiro', 'warning');
                return;
            }
            
            const nameInput = document.getElementById('new-attribute-name');
            const typeSelect = document.getElementById('new-attribute-type');
            
            const name = nameInput.value.trim().toUpperCase();
            const type = typeSelect.value;
            
            // Valida√ß√£o
            if (!name) {
                showFeedback('Digite um nome para o atributo', 'warning');
                return;
            }
            
            const mandatoryAttributes = state.playerData.attributesConfig?.mandatory || [];
            const optionalAttributes = state.playerData.attributesConfig?.optional || [];
            
            if (mandatoryAttributes.includes(name) || optionalAttributes.includes(name)) {
                showFeedback('Atributo j√° existe', 'warning');
                return;
            }
            
            // Verifica limites
            if (type === 'mandatory') {
                if (mandatoryAttributes.length >= CONFIG.MAX_MANDATORY_ATTRIBUTES) {
                    showFeedback(`M√°ximo de ${CONFIG.MAX_MANDATORY_ATTRIBUTES} atributos obrigat√≥rios`, 'warning');
                    return;
                }
            }
            
            try {
                state.isLoading = true;
                
                // Atualiza arrays de atributos
                const updatedAttributesConfig = { 
                    ...state.playerData.attributesConfig,
                    mandatory: [...mandatoryAttributes],
                    optional: [...optionalAttributes]
                };
                
                if (type === 'mandatory') {
                    updatedAttributesConfig.mandatory.push(name);
                } else {
                    updatedAttributesConfig.optional.push(name);
                }
                
                // Atualiza streaks se necess√°rio
                const updatedStreaks = { ...state.playerData.streaks };
                if (!updatedStreaks[name]) {
                    updatedStreaks[name] = 0;
                }
                
                // Envia atualiza√ß√£o para API
                await updatePlayer(state.playerData.player, {
                    attributesConfig: updatedAttributesConfig,
                    streaks: updatedStreaks
                });
                
                // Limpa formul√°rio
                nameInput.value = '';
                
                // Atualiza UI
                updateUI();
                
                showFeedback(`Atributo "${name}" criado!`, 'success');
            } catch (error) {
                showFeedback('Erro ao criar atributo', 'danger');
            } finally {
                state.isLoading = false;
            }
        }

        async function removeAttribute(attributeName) {
            if (!state.playerData) return;
            
            if (!confirm(`Remover atributo "${attributeName}"? Os h√°bitos associados tamb√©m ser√£o removidos.`)) {
                return;
            }
            
            try {
                state.isLoading = true;
                
                const mandatoryAttributes = state.playerData.attributesConfig?.mandatory || [];
                const optionalAttributes = state.playerData.attributesConfig?.optional || [];
                
                // Remove atributo dos arrays apropriados
                const updatedMandatory = mandatoryAttributes.filter(name => name !== attributeName);
                const updatedOptional = optionalAttributes.filter(name => name !== attributeName);
                
                // Remove h√°bitos associados
                const updatedHabits = (state.playerData.habits || []).filter(habit => 
                    habit.attribute !== attributeName
                );
                
                // Remove do streaks
                const updatedStreaks = { ...state.playerData.streaks };
                delete updatedStreaks[attributeName];
                
                // Remove do attributePoints
                const updatedAttributePoints = { ...state.playerData.attributePoints };
                delete updatedAttributePoints[attributeName];
                
                // Envia atualiza√ß√£o para API
                await updatePlayer(state.playerData.player, {
                    attributesConfig: {
                        mandatory: updatedMandatory,
                        optional: updatedOptional
                    },
                    habits: updatedHabits,
                    streaks: updatedStreaks,
                    attributePoints: updatedAttributePoints
                });
                
                // Atualiza UI
                updateUI();
                
                showFeedback(`Atributo "${attributeName}" removido`, 'success');
            } catch (error) {
                showFeedback('Erro ao remover atributo', 'danger');
            } finally {
                state.isLoading = false;
            }
        }

        async function addHabit() {
            if (!state.playerData) {
                showFeedback('Selecione ou crie um jogador primeiro', 'warning');
                return;
            }
            
            const nameInput = document.getElementById('new-habit-name');
            const attributeSelect = document.getElementById('new-habit-attribute');
            const typeSelect = document.getElementById('new-habit-type');
            const targetInput = document.getElementById('new-habit-target');
            
            const name = nameInput.value.trim();
            const attribute = attributeSelect.value;
            const type = typeSelect.value;
            const target = parseInt(targetInput.value) || 1;
            
            // Valida√ß√£o
            if (!name) {
                showFeedback('Digite um nome para o h√°bito', 'warning');
                return;
            }
            
            if (!attribute) {
                showFeedback('Selecione um atributo', 'warning');
                return;
            }
            
            if (target < 1) {
                showFeedback('A meta deve ser pelo menos 1', 'warning');
                return;
            }
            
            // Verifica se atributo √© obrigat√≥rio
            const mandatoryAttributes = state.playerData.attributesConfig?.mandatory || [];
            if (!mandatoryAttributes.includes(attribute)) {
                showFeedback('H√°bitos s√≥ podem ser criados para atributos obrigat√≥rios', 'warning');
                return;
            }
            
            try {
                state.isLoading = true;
                
                // Cria novo h√°bito
                const newHabit = {
                    name,
                    attribute,
                    type,
                    value: type === 'binary' ? 1 : target,
                    currentValue: 0,
                    completed: false,
                    points: type === 'binary' ? CONFIG.BINARY_HABIT_POINTS : CONFIG.QUANTITATIVE_POINTS_PER_UNIT
                };
                
                // Adiciona √† lista de h√°bitos
                const updatedHabits = [...(state.playerData.habits || []), newHabit];
                
                // Envia atualiza√ß√£o para API
                await updatePlayer(state.playerData.player, {
                    habits: updatedHabits
                });
                
                // Limpa formul√°rio
                nameInput.value = '';
                targetInput.value = '1';
                
                // Atualiza UI
                updateUI();
                
                showFeedback(`H√°bito "${name}" criado!`, 'success');
            } catch (error) {
                showFeedback('Erro ao criar h√°bito', 'danger');
            } finally {
                state.isLoading = false;
            }
        }

        async function removeHabit(habitIndex) {
            if (!state.playerData) return;
            
            const habits = state.playerData.habits || [];
            if (habitIndex < 0 || habitIndex >= habits.length) return;
            
            const habit = habits[habitIndex];
            
            if (!confirm(`Remover h√°bito "${habit.name}"?`)) {
                return;
            }
            
            try {
                state.isLoading = true;
                
                // Remove h√°bito da lista
                const updatedHabits = habits.filter((_, index) => index !== habitIndex);
                
                // Envia atualiza√ß√£o para API
                await updatePlayer(state.playerData.player, {
                    habits: updatedHabits
                });
                
                // Atualiza UI
                updateUI();
                
                showFeedback(`H√°bito "${habit.name}" removido`, 'success');
            } catch (error) {
                showFeedback('Erro ao remover h√°bito', 'danger');
            } finally {
                state.isLoading = false;
            }
        }

        function generateLog() {
            if (!state.playerData) {
                showFeedback('Selecione ou crie um jogador primeiro', 'warning');
                return;
            }
            
            const logDate = document.getElementById('log-date').value || state.currentDate;
            
            // Cria objeto JSON com dados do jogador
            const logData = {
                player: state.playerData.player,
                date: logDate,
                attributesConfig: state.playerData.attributesConfig,
                habits: state.playerData.habits || [],
                attributePoints: state.playerData.attributePoints || {},
                streaks: state.playerData.streaks || {},
                totalPoints: state.playerData.totalPoints || 0,
                level: state.playerData.level || 1
            };
            
            // Exibe log
            const logOutput = document.getElementById('log-output');
            const logContainer = document.getElementById('log-output-container');
            
            logOutput.textContent = JSON.stringify(logData, null, 2);
            logContainer.style.display = 'block';
            
            showFeedback('Log gerado com sucesso!', 'success');
        }

        function copyLog() {
            const logOutput = document.getElementById('log-output');
            
            if (!logOutput.textContent) {
                showFeedback('Gere o log primeiro', 'warning');
                return;
            }
            
            navigator.clipboard.writeText(logOutput.textContent)
                .then(() => showFeedback('Log copiado!', 'success'))
                .catch(() => {
                    // Fallback para navegadores antigos
                    const textArea = document.createElement('textarea');
                    textArea.value = logOutput.textContent;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showFeedback('Log copiado!', 'success');
                });
        }

        // ============================================
        // FUN√á√ïES UTILIT√ÅRIAS
        // ============================================
        function formatDate(date, full = false) {
            const d = new Date(date);
            const options = full ? {
                weekday: 'short',
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            } : {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            };
            
            return d.toLocaleDateString('pt-BR', options);
        }

        function showFeedback(message, type = 'success') {
            const feedback = document.getElementById('feedback-toast');
            const icon = feedback.querySelector('.feedback-icon i');
            const messageEl = document.getElementById('feedback-message');
            
            // Configura tipo
            feedback.className = 'feedback';
            feedback.classList.add(type);
            
            // Configura √≠cone
            icon.className = {
                'success': 'fas fa-check',
                'warning': 'fas fa-exclamation-triangle',
                'danger': 'fas fa-times-circle'
            }[type] || 'fas fa-info-circle';
            
            // Configura mensagem
            messageEl.textContent = message;
            
            // Mostra feedback
            feedback.classList.remove('d-none');
            
            // Esconde ap√≥s 3 segundos
            setTimeout(() => {
                feedback.classList.add('d-none');
            }, 3000);
        }

        function switchScreen(screenName) {
            // Esconde todas as telas
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Mostra tela selecionada
            const targetScreen = document.getElementById(`${screenName}-screen`);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            
            // Atualiza tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.screen === screenName) {
                    tab.classList.add('active');
                }
            });
            
            // Atualiza indicador
            document.querySelectorAll('.tab-indicator span').forEach((span, index) => {
                span.classList.remove('active');
                const tabNames = ['home', 'setup', 'log'];
                if (index === tabNames.indexOf(screenName)) {
                    span.classList.add('active');
                }
            });
            
            // Atualiza UI espec√≠fica da tela
            if (screenName === 'log') {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('log-date').value = today;
            }
            
            // Garante que o UI seja atualizado
            updateUI();
        }

        function setupEventListeners() {
            // Navega√ß√£o
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    switchScreen(tab.dataset.screen);
                });
            });
            
            // Data
            document.getElementById('prev-date').addEventListener('click', () => {
                const date = new Date(state.currentDate);
                date.setDate(date.getDate() - 1);
                state.currentDate = date.toISOString().split('T')[0];
                updateUI();
            });
            
            document.getElementById('next-date').addEventListener('click', () => {
                const date = new Date(state.currentDate);
                const today = new Date().toISOString().split('T')[0];
                date.setDate(date.getDate() + 1);
                
                // N√£o permite datas futuras
                if (date.toISOString().split('T')[0] <= today) {
                    state.currentDate = date.toISOString().split('T')[0];
                    updateUI();
                }
            });
            
            // Salvar nome
            document.getElementById('save-player-name').addEventListener('click', async () => {
                const name = document.getElementById('player-name').value.trim();
                if (name && state.playerData && name !== state.playerData.player) {
                    try {
                        state.isLoading = true;
                        
                        // Cria novo jogador com os dados do atual
                        const newPlayerData = {
                            ...state.playerData,
                            player: name
                        };
                        
                        await createPlayer(newPlayerData);
                        
                        // Remove o jogador antigo
                        await deletePlayer(state.playerData.player);
                        
                        updateUI();
                        showFeedback('Nome alterado com sucesso!', 'success');
                    } catch (error) {
                        showFeedback('Erro ao alterar nome', 'danger');
                    } finally {
                        state.isLoading = false;
                    }
                }
            });
            
            // Salvar progresso di√°rio
            document.getElementById('save-daily').addEventListener('click', saveDailyProgress);
            
            // Adicionar atributo
            document.getElementById('add-attribute').addEventListener('click', addAttribute);
            
            // Adicionar h√°bito
            document.getElementById('add-habit').addEventListener('click', addHabit);
            
            // Log
            document.getElementById('generate-log').addEventListener('click', generateLog);
            document.getElementById('copy-log').addEventListener('click', copyLog);
            
            // Modo guiado
            document.getElementById('start-guided-mode').addEventListener('click', () => {
                document.getElementById('guided-modal').style.display = 'flex';
            });
            
            document.getElementById('close-guided-modal').addEventListener('click', () => {
                document.getElementById('guided-modal').style.display = 'none';
            });
            
            document.querySelectorAll('.guided-option').forEach(option => {
                option.addEventListener('click', async function() {
                    const area = this.dataset.area;
                    const suggestion = GUIDED_SUGGESTIONS[area];
                    
                    if (!state.playerData) return;
                    
                    try {
                        state.isLoading = true;
                        
                        // Adiciona atributo se necess√°rio
                        const mandatoryAttributes = state.playerData.attributesConfig?.mandatory || [];
                        if (!mandatoryAttributes.includes(suggestion.attribute)) {
                            const updatedMandatory = [...mandatoryAttributes, suggestion.attribute];
                            
                            // Atualiza streaks
                            const updatedStreaks = { ...state.playerData.streaks };
                            updatedStreaks[suggestion.attribute] = 0;
                            
                            await updatePlayer(state.playerData.player, {
                                attributesConfig: {
                                    ...state.playerData.attributesConfig,
                                    mandatory: updatedMandatory
                                },
                                streaks: updatedStreaks
                            });
                        }
                        
                        // Adiciona h√°bito
                        const newHabit = {
                            name: suggestion.habit,
                            attribute: suggestion.attribute,
                            type: suggestion.type,
                            value: suggestion.type === 'binary' ? 1 : suggestion.target,
                            currentValue: 0,
                            completed: false,
                            points: suggestion.type === 'binary' ? CONFIG.BINARY_HABIT_POINTS : CONFIG.QUANTITATIVE_POINTS_PER_UNIT * suggestion.target
                        };
                        
                        const updatedHabits = [...(state.playerData.habits || []), newHabit];
                        
                        await updatePlayer(state.playerData.player, {
                            habits: updatedHabits
                        });
                        
                        // Mostra resultado
                        const resultDiv = document.getElementById('guided-result');
                        const suggestionDiv = document.getElementById('guided-suggestion');
                        const phraseDiv = document.getElementById('motivational-phrase');
                        
                        suggestionDiv.innerHTML = `
                            <div style="text-align: center;">
                                <i class="${suggestion.icon}" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                                <h4 style="margin-bottom: 5px;">${suggestion.attribute}</h4>
                                <p style="color: var(--gray); margin-bottom: 10px;">${suggestion.habit}</p>
                                <p style="font-size: 0.9rem; color: var(--warning);">
                                    <i class="fas fa-lock"></i> Bloqueado por ${CONFIG.GUIDED_LOCK_DAYS} dias
                                </p>
                            </div>
                        `;
                        
                        // Frase motivacional aleat√≥ria
                        phraseDiv.textContent = MOTIVATIONAL_PHRASES[Math.floor(Math.random() * MOTIVATIONAL_PHRASES.length)];
                        
                        resultDiv.style.display = 'block';
                        
                        // Atualiza UI
                        updateUI();
                        
                        showFeedback('Modo guiado ativado!', 'success');
                        
                        // Fecha modal ap√≥s 3 segundos
                        setTimeout(() => {
                            document.getElementById('guided-modal').style.display = 'none';
                            resultDiv.style.display = 'none';
                            switchScreen('home');
                        }, 3000);
                    } catch (error) {
                        showFeedback('Erro ao ativar modo guiado', 'danger');
                    } finally {
                        state.isLoading = false;
                    }
                });
            });
            
            // Fechar modal ao clicar fora
            document.getElementById('guided-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('guided-modal')) {
                    document.getElementById('guided-modal').style.display = 'none';
                }
            });
            
            // Enter para adicionar
            document.getElementById('new-attribute-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addAttribute();
            });
            
            document.getElementById('new-habit-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addHabit();
            });
        }
    </script>
</body>
</html>
